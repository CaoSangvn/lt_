<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Chat nội bộ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Roboto', sans-serif; background: #ecf0f1; margin: 0; padding: 0; }
    #announcement-banner {
        background-color: #fff3cd; color: #856404; padding: 15px;
        text-align: center; border-bottom: 1px solid #ffeeba;
        display: none;
        position: relative;
    }
    #announcement-banner .close-btn {
        position: absolute; top: 50%; right: 15px;
        transform: translateY(-50%); font-size: 24px;
        cursor: pointer; font-weight: bold;
    }
    .container { max-width: 800px; margin: 40px auto; background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; height: calc(100vh - 80px); }
    .header { background-color: #007bff; color: white; padding: 15px 20px; font-size: 1.2em; border-bottom: 1px solid #ddd; }
    .header a { color: white; text-decoration: none; }
    .header a:hover { text-decoration: underline; }
    #messages { padding: 20px; overflow-y: auto; background-color: #fff; flex-grow: 1; }
    .message-container { display: flex; margin-bottom: 15px; }
    .message-container.sent { justify-content: flex-end; }
    .message-container.received { justify-content: flex-start; }
    .message { max-width: 70%; padding: 10px 15px; border-radius: 18px; word-wrap: break-word; position: relative; }
    .message.sent { background-color: #007bff; color: white; border-radius: 18px 18px 5px 18px; }
    .message.sent strong { color: #f1f1f1; }
    .message.received { background-color: #f1f1f1; color: #333; border: 1px solid #e1e1e1; border-radius: 18px 18px 18px 5px; }
    .message.received strong { color: #007bff; }
    .message-header { margin-bottom: 5px; }
    .message-header strong { font-size: 0.9em; }
    .message-header .timestamp { font-size: 0.75em; color: #a1a1a1; margin-left: 8px; }
    .message.sent .timestamp { color: #e1f5fe; }
    .message p { margin: 0; }
    .message img { margin-top: 10px; max-width: 100%; border-radius: 10px; display: block; }
    .file-attachment { display: inline-block; margin-top: 10px; padding: 8px 12px; background-color: #e9ecef; border: 1px solid #ced4da; border-radius: 5px; text-decoration: none; color: #007bff; }

    form#chat-form { display: flex; gap: 5px; padding: 10px; background: #fff; border-top: 1px solid #e1e1e1; align-items: center;}
    #message { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px 15px; font-size: 16px; } /* Tăng font-size cho dễ nhập liệu */
    #message:focus { outline: none; border-color: #007bff; }
    
    input[type="file"] { display: none; }

    .file-label, form#chat-form button {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 20px;
        flex-shrink: 0;
        transition: background-color 0.2s;
    }

    .file-label {
        background-color: #f1f1f1;
        border: 1px solid #ccc;
    }
    .file-label:hover { background-color: #e1e1e1; }

    form#chat-form button {
        background-color: #007bff;
        border: none;
        color: white;
        font-weight: bold;
    }
    form#chat-form button:hover { background-color: #0056b3; }

    @media (max-width: 768px) {
        body {
            background: white;
        }
        .container {
            width: 100%;
            height: 100vh;
            margin: 0;
            border-radius: 0;
            box-shadow: none;
        }
        #messages {
            padding: 10px;
        }
    }
  </style>
</head>
<body>
  <div id="announcement-banner">
      <span id="announcement-content">
        {% if announcement %}
            <strong>Thông báo từ Admin {{ announcement.admin_username }}:</strong> {{ announcement.content }}
        {% endif %}
      </span>
      <span class="close-btn" onclick="this.parentElement.style.display='none';">&times;</span>
  </div>

  <div class="container">
    <div class="header">
        Phòng Chat Chung
    </div>
    <div id="messages">
      {% for msg in messages %}
        <div class="message-container {% if msg.username == username %}sent{% else %}received{% endif %}">
            <div class="message {% if msg.username == username %}sent{% else %}received{% endif %}">
              <div class="message-header">
                <strong>{{ msg.username }}</strong>
                <span class="timestamp">{{ msg.timestamp.strftime('%H:%M') if msg.timestamp else '' }}</span>
              </div>
              {% if msg.message %}<p>{{ msg.message }}</p>{% endif %}
              {% if msg.image_path %}<img src="{{ msg.image_path }}" alt="ảnh">{% endif %}
              {% if msg.file_path %}<a href="{{ msg.file_path }}" class="file-attachment" download>Tải xuống: {{ msg.file_path.split('_')[-1] }}</a>{% endif %}
            </div>
        </div>
      {% endfor %}
    </div>
    <form id="chat-form">
      <input type="text" id="message" placeholder="Nhập tin nhắn..." autocomplete="off" />
      
      <label for="image" title="Gửi ảnh" class="file-label">&#128443;&#xFE0F;</label> <input type="file" id="image" name="image" accept="image/*"/>
      
      <label for="file" title="Gửi file" class="file-label">&#128206;</label> <input type="file" id="file" name="file"/>
      
      <button type="submit" title="Gửi">&#10148;</button> </form>
  </div>

  <script>
    const socket = io();
    const form = document.getElementById('chat-form');
    const msgEl = document.getElementById('messages');
    const username = "{{ username }}";

    // --- TOÀN BỘ SCRIPT CẦN THIẾT ---

    // 1. Logic nhận tin nhắn chat thông thường
    socket.on('receive_message', data => {
      const isSentByMe = data.user === username;
      const messageContainer = document.createElement('div');
      messageContainer.className = `message-container ${isSentByMe ? 'sent' : 'received'}`;
      const messageBubble = document.createElement('div');
      messageBubble.className = `message ${isSentByMe ? 'sent' : 'received'}`;
      let messageContent = `
        <div class="message-header">
          <strong>${escapeHtml(data.user)}</strong>
          <span class="timestamp">${data.timestamp ? data.timestamp.split(',')[0] : ''}</span>
        </div>`;
      if (data.message) messageContent += `<p>${escapeHtml(data.message)}</p>`;
      if (data.image) messageContent += `<img src="${data.image}" alt="ảnh">`;
      if (data.file_info && data.file_info.url) {
        messageContent += `<a href="${data.file_info.url}" class="file-attachment" download="${escapeHtml(data.file_info.name)}">Tải xuống: ${escapeHtml(data.file_info.name)}</a>`;
      }
      messageBubble.innerHTML = messageContent;
      messageContainer.appendChild(messageBubble);
      msgEl.appendChild(messageContainer);
      msgEl.scrollTop = msgEl.scrollHeight;
      if (Notification.permission === 'granted' && !isSentByMe && document.hidden) {
        const notification = new Notification(`Tin nhắn mới từ ${data.user}`, {
          body: data.message || 'Đã gửi một tệp đính kèm',
          icon: '/static/image/chat_icon.png'
        });
      }
    });

    // 2. Logic nhận thông báo từ Admin (MỚI)
    socket.on('new_announcement', function(data) {
        const banner = document.getElementById('announcement-banner');
        const content = document.getElementById('announcement-content');
        content.innerHTML = `<strong>Thông báo từ Admin ${escapeHtml(data.admin)}:</strong> ${escapeHtml(data.content)}`;
        banner.style.display = 'block';
    });

    // 3. Logic gửi form
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const message = document.getElementById('message').value.trim();
      const imageFile = document.getElementById('image').files[0];
      const otherFile = document.getElementById('file').files[0];
      if (!message && !imageFile && !otherFile) return;
      const data = { message };
      if (imageFile) data.image = { filename: imageFile.name, data: await toBase64(imageFile) };
      if (otherFile) data.file = { filename: otherFile.name, data: await toBase64(otherFile) };
      socket.emit('send_message', data);
      form.reset();
    });

    // 4. Logic chạy khi tải trang (MỚI)
    document.addEventListener('DOMContentLoaded', function() {
        msgEl.scrollTop = msgEl.scrollHeight;
        const banner = document.getElementById('announcement-banner');
        const content = document.getElementById('announcement-content').innerText.trim();
        if (content) {
            banner.style.display = 'block';
        }
        requestNotificationPermission();
    });

    // 5. Các hàm trợ giúp
    function requestNotificationPermission() {
      if ("Notification" in window && Notification.permission !== "denied") {
        Notification.requestPermission();
      }
    }
    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
    }
  </script>
</body>
</html>